#!/usr/bin/env node

const PackageDetector = require("../lib/utils/package-detector");
const TypeScriptLibraryBuilder = require("../lib/builders/typescript-library");
const TypeScriptAppBuilder = require("../lib/builders/typescript-app");
const PythonLibraryBuilder = require("../lib/builders/python-library");
const PythonAppBuilder = require("../lib/builders/python-app");
const ConfigPackageBuilder = require("../lib/builders/config-package");

const createLogger = require("../../alphab-logging-ui/src/index").createLogger;
const logger = createLogger("alphab-type-check");

async function main() {
  try {
    const detector = new PackageDetector();
    const packageType = detector.getPackageType();
    const packageName = detector.getPackageName();

    logger.log(`🔎 Type checking ${packageName} (${packageType})`);

    let builder;
    switch (packageType) {
      case "typescript-library":
        logger.log("🔎 Type checking typescript library");
        builder = new TypeScriptLibraryBuilder(detector);
        break;
      case "typescript-app":
        logger.log("🔎 Type checking typescript app");
        builder = new TypeScriptAppBuilder(detector);
        break;
      case "python-library":
        logger.log("🔎 Type checking python library");
        builder = new PythonLibraryBuilder(detector);
        break;
      case "python-app":
        logger.log("🔎 Type checking python app");
        builder = new PythonAppBuilder(detector);
        break;
      case "config-package":
        logger.log("🔎 Type checking config package");
        builder = new ConfigPackageBuilder(detector);
        break;
      default:
        logger.error(`❌ Unknown package type: ${packageType}`);
        process.exit(1);
    }

    await builder.typeCheck();
    logger.log(`🎉 Type checking passed for ${packageName}`);
  } catch (error) {
    logger.error(`💥 Type checking failed: ${error.message}`);
    process.exit(1);
  }
}

main();
